version: '3.8'

services:
    db:
        image: postgres:15-alpine
        container_name: my_postgres_db
        restart: always
        environment:
            - POSTGRES_USER=${POSTGRES_USER:-myuser}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-mysecretpassword}
            - POSTGRES_DB=${POSTGRES_DB:-my_learning_db}
        ports:
            - "5432:5432"
        volumes:
            # Đây là phần quan trọng nhất:
            # Nó ánh xạ thư mục postgres_data ở máy EC2 vào thư mục data của Postgres trong container
            - ./postgres_data:/var/lib/postgresql/data
        networks:
            - private_network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U myuser -d my_learning_db"]
            interval: 10s
            timeout: 5s
            retries: 5

    # Backend API Service (you need to create this)
    backend:
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 40s
        build:
            context: ./social_for_bros_api
            dockerfile: Dockerfile
        container_name: backend_api
        restart: always
        environment:
            - PORT=${BACKEND_PORT:-3001}
            - NODE_ENV=${NODE_ENV:-production}
            - DATABASE_URL=${DATABASE_URL:-postgresql://myuser:mysecretpassword@db:5432/my_learning_db}
            - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-this-in-production}
            - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
            - CORS_ORIGIN=${CORS_ORIGIN:-http://api-gateway:3000}
        ports:
            - "3001:3001"
        depends_on:
            db:
                condition: service_healthy
        networks:
            - private_network

    # Frontend Web Service (you need to create this)
    frontend:
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4200/"]
            interval: 15s
            timeout: 10s
            retries: 10
            start_period: 60s
        build: 
            context: ./social_for_bros_web
            dockerfile: Dockerfile
        container_name: frontend_web
        restart: always
        environment:
            - PORT=${FRONTEND_PORT:-4200}
            - NODE_ENV=${NODE_ENV:-production}
            - API_URL=${API_URL:-http://api-gateway:3000}
            - API_PREFIX=${API_PREFIX:-api}
            - API_VERSION=${API_VERSION:-v1}
        ports:
            - "4200:4200"
        networks:
            - private_network

    api-gateway:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: api_gateway
        restart: always
        environment:
            - NODE_ENV=${NODE_ENV:-production}
            - PORT=${GATEWAY_PORT:-3000}
            - CORS_URL=${CORS_URL:-*}
            - BACKEND_URL=${BACKEND_URL:-http://backend:3001}
            - FRONTEND_URL=${FRONTEND_URL:-http://frontend:4200} 
        ports:
            - "3000:3000"
        depends_on:
            backend:
                condition: service_started
            frontend:
                condition: service_started
        networks:
            - private_network

    # --- NGINX PROXY MANAGER (NPM) ---
    # nginx-proxy-manager:
    #     image: 'jc21/nginx-proxy-manager:latest'
    #     container_name: nginx_proxy_manager
    #     restart: always
    #     ports:
    #     - '80:80'    # Cổng HTTP công cộng
    #     - '443:443'  # Cổng HTTPS công cộng
    #     - '81:81'    # Cổng quản lý Admin (Nên giới hạn IP nếu có thể)
    #     volumes:
    #     - ./npm_data:/data
    #     - ./npm_letsencrypt:/etc/letsencrypt
    #     networks:
    #     - private_network
    
    nginx:
        image: nginx:1.29.4
        container_name: nginx_reverse_proxy
        restart: always
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
        networks:
            - private_network

networks:
    private_network:
        driver: bridge
