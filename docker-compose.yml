version: '3.8'

services:
    db:
        image: postgres:15-alpine
        container_name: my_postgres_db
        restart: always
        environment:
            POSTGRES_USER: myuser
            POSTGRES_PASSWORD: mysecretpassword
            POSTGRES_DB: my_learning_db
        ports:
            - "5432:5432"
        volumes:
            # Đây là phần quan trọng nhất:
            # Nó ánh xạ thư mục postgres_data ở máy EC2 vào thư mục data của Postgres trong container
            - ./postgres_data:/var/lib/postgresql/data
        networks:
            - private_network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U myuser -d my_learning_db"]
            interval: 10s
            timeout: 5s
            retries: 5

    # Backend API Service (you need to create this)
    backend:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: backend_api
        restart: always
        environment:
            - NODE_ENV=production
            - DATABASE_URL=postgresql://myuser:mysecretpassword@db:5432/my_learning_db
            - PORT=3001
        ports:
            - "3001:3001"
        depends_on:
            db:
                condition: service_healthy
        networks:
            - private_network

    # Frontend Web Service (you need to create this)
    frontend:
        build: 
            context: .
            dockerfile: Dockerfile
        container_name: frontend_web
        restart: always
        environment:
            - NODE_ENV=production
            - PORT=4200
        ports:
            - "4200:4200"
        networks:
            - private_network

    api-gateway:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: api_gateway
        restart: always
        environment:
            - NODE_ENV=production
            - PORT=3000
            # (Because of Docker networking, we use the service name 'backend')
            - BACKEND_URL=http://backend:3001
            # (Because of Docker networking, we use the service name 'frontend')
            - FRONTEND_URL=http://frontend:4200 
        ports:
            - "3000:3000"
        depends_on:
            - backend
            - frontend
        networks:
            - private_network

networks:
    private_network:
        driver: bridge
